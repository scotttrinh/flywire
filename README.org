* flywire

~flywire~ is an Emacs package that serves as the "arms and eyes" for automated agents (such as LLMs) operating within Emacs. It enables external processes to observe the editor's state and execute interactive commands programmatically in the current user session.

It separates the mechanics of "driving" Emacs from the agent's decision logic, offering a robust, session-based API that handles sync/async execution, environments (interactive vs headless), and structured observation.

* Installation

** Doom Emacs

Add the following to your ~$DOOMDIR/packages.el~:

#+begin_src elisp
(package! flywire :recipe (:host github :repo "scotttrinh/flywire"))
#+end_src

Then run ~doom sync~.

Load it in your ~$DOOMDIR/config.el~:

#+begin_src elisp
(use-package! flywire
  :config
  ;; Optional configuration
  )
#+end_src

** Straight.el

#+begin_src elisp
(straight-use-package
 '(flywire :type git :host github :repo "scotttrinh/flywire"))
#+end_src

* Core Concepts

Flywire is built around four key concepts:

- **Sessions**: A `flywire-session` represents a single driver instance. It holds configuration and state for an agent's interaction loop.
- **Environments**: A `flywire-env` defines *where* the session runs (e.g., the current frame, a dedicated agent frame, or a headless buffer).
- **Actions**: Native Emacs commands and special tools (like `type_text` or `goto_location`) that the agent can invoke.
- **Snapshots**: Structured views of the editor state (buffer content, cursor, windows), configurable via profiles.

* Usage

** Basic Execution (Sync)

For simple scripts or REPL usage, you can use `flywire-do` (legacy wrapper) or the session API directly.

#+begin_src elisp
(require 'flywire)

;; Create a session using the default environment (current frame)
(let ((session (flywire-session-create)))
  (flywire-session-exec session
    '(((action . "type_text") (text . "Hello World"))
      ((action . "press_key") (key . "RET")))))
#+end_src

** Async Execution & Events

For interactive agents that need to react to minibuffer prompts or idle state, use `flywire-session-start-async`.

#+begin_src elisp
(defun my-event-handler (event)
  (pcase (plist-get event :type)
    (:step-end (message "Finished step: %s" (plist-get event :result)))
    (:minibuffer-open (message "Minibuffer opened! Snapshot: %s" (plist-get event :snapshot)))))

(let ((session (flywire-session-create)))
  (flywire-session-on-event session #'my-event-handler)
  (flywire-session-start-async session
    '(((action . "run_command") (name . "find-file"))
      ((action . "type_text") (text . "/tmp/test.txt"))
      ((action . "press_key") (key . "RET")))))
#+end_src

* Configuration

** Snapshot Profiles

Snapshots can be expensive. Use profiles to control data volume.

#+begin_src elisp
;; Use the 'minimal' profile for low-latency checks
(flywire-snapshot-get-snapshot 'minimal)

;; Use 'rich' for full context (includes visible content, messages, etc.)
(flywire-snapshot-get-snapshot 'rich)
#+end_src

Define your own profiles in `flywire-snapshot-profiles`.

** Snapshot Extensions

Add custom data to snapshots using `flywire-snapshot-collect-hook`.

#+begin_src elisp
(add-hook 'flywire-snapshot-collect-hook
          (lambda (snap)
            (plist-put snap :my-custom-field "some data")))
#+end_src

** Safety Policy

Restrict which commands an agent can run using `flywire-allow-command-p`.

#+begin_src elisp
(setq flywire-allow-command-p
      (lambda (cmd)
        (memq cmd '(next-line previous-line self-insert-command))))
#+end_src

* Action Registry

Flywire maps string-based tool names to Emacs functions. Standard tools include:

- `type_text`: Insert text.
- `press_key`: Simulate key chords (`RET`, `C-c C-c`).
- `run_command`: Execute interactive commands.
- `cancel`: Simulate `C-g`.
- `goto_location`: Jump to point/line/column.

Register custom actions:

#+begin_src elisp
(flywire-register-action "my_tool"
  (lambda (args)
    (message "Tool called with: %s" args)))
#+end_src

* Development

** Testing

Run the full test suite with Nix:

#+begin_src sh
nix run .#test
#+end_src

See [[file:AGENT.md][AGENT.md]] for contribution guidelines.