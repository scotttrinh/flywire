* flywire

~flywire~ is an Emacs package that serves as the "arms and eyes" for automated agents (such as LLMs) operating within Emacs. It enables external processes to observe the editor's state and execute interactive commands programmatically in the current user session.

It provides two core capabilities:
1. **Observation**: Generates JSON-serializable snapshots of the current frame, including buffer content, cursor position, window configuration, and minibuffer state.
2. **Execution**: precise simulation of user input (keystrokes, text entry) and interactive command execution.

This package is designed to separate the low-level "driving" mechanics from the high-level "agent" logic, ensuring robust and predictable control.

* Installation

** Doom Emacs

Add the following to your ~$DOOMDIR/packages.el~:

#+begin_src elisp
(package! flywire :recipe (:host github :repo "scotttrinh/flywire"))
#+end_src

Then run ~doom sync~.

Load it in your ~$DOOMDIR/config.el~:

#+begin_src elisp
(use-package! flywire
  :config
  ;; Optional configuration
  )
#+end_src

** Straight.el

Add the following to your configuration:

#+begin_src elisp
(straight-use-package
 '(flywire :type git :host github :repo "scotttrinh/flywire"))
#+end_src

** Manual / package.el

Clone the repository:

#+begin_src sh
git clone https://github.com/scotttrinh/flywire.git ~/.emacs.d/site-lisp/flywire
#+end_src

Add it to your ~load-path~ and require it:

#+begin_src elisp
(add-to-list 'load-path "~/.emacs.d/site-lisp/flywire")
(require 'flywire)
#+end_src

* Usage

The core entry point is ~flywire-do~, which accepts either a JSON string or a native Elisp list describing a sequence of actions.

#+begin_src elisp
;; Using JSON string
(flywire-do
 "[{\"action\": \"type\", \"text\": \"Hello World\"}, {\"action\": \"key\", \"chord\": \"RET\"}]")

;; Using Elisp structure (faster, no parsing overhead)
(flywire-do
 '(((action . "type") (text . "Hello World"))
   ((action . "key") (chord . "RET"))))
#+end_src

* Configuration

Flywire is designed to be configurable to manage the trade-off between context availability and resource usage (e.g., token counts for LLM agents).

** Snapshot Content

You can control how much information is gathered in each snapshot using ~flywire-snapshot-collectors~.

#+begin_src elisp
;; Only collect buffer info and cursor position (minimal token usage)
(setq flywire-snapshot-collectors '(buffer-info cursor))

;; Default: collect everything
(setq flywire-snapshot-collectors
      '(buffer-info content cursor minibuffer window-configuration))
#+end_src

** Context Window

When capturing buffer content, you can limit the size of the text window to avoid overwhelming the agent.

#+begin_src elisp
;; Number of lines to capture above and below the cursor (default: 50)
(setq flywire-snapshot-context-lines 20)

;; Maximum characters per line to capture before truncating (default: 1000)
;; This is useful for preventing "minified file" issues.
(setq flywire-snapshot-max-line-length 500)
#+end_src

** Async Handling

If you are using ~flywire-do-async~ or the ~flywire-async-mode~, you can customize how state updates are emitted.

#+begin_src elisp
;; Define a custom handler for snapshot updates
(defun my-agent-handler (snapshot)
  (let ((json-string (json-encode snapshot)))
    (process-send-string my-agent-process json-string)))

(setq flywire-async-output-handler #'my-agent-handler)
#+end_src

* Development

** Testing

This project uses [[https://nixos.org/][Nix]] to manage development dependencies and test environments.

To run the full test suite:

#+begin_src sh
nix run .#test
#+end_src

To run tests manually in a development shell:

#+begin_src sh
nix develop
emacs -q --batch -l test/run-tests.el
#+end_src

** Workflow

Development follows a "Plan vs Notes" workflow recorded in the ~devlogs/~ directory.
- **Plans**: Detailed specifications of intended changes (e.g., ~YYYYMMDDHHMM-Plan_Phase_N.org~).
- **Notes**: Retrospective logs of what was actually implemented, issues encountered, and decisions made (e.g., ~YYYYMMDDHHMM-Notes_*.org~).

Please refer to [[file:AGENT.md][AGENT.md]] for detailed contribution guidelines and coding conventions.
